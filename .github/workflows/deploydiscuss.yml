name: deploydiscuss

on:
  #push:
  workflow_dispatch:

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_PROJECT_NAME: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}
  DEPLOYMENT_ENVIRONMENT: production
  PRODUCTION_BRANCH: main

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment:
      name: ${{ github.event.inputs.DEPLOYMENT_ENVIRONMENT }}
    steps:

      - name: Checkout
        uses: actions/checkout@v3

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: 17.x
          #tmpcomment      cache: 'yarn'


      - name: deploy to cfpagesaio
        run: |

          #not needed anymore,directly edit it inside db
          #sudo sh -c "for i in _tmpbuild/_build/discuss/_worker.js _tmpbuild/_build/discuss/app.js;do toreplace=\`cat \$i|grep -Po '(?<=https://t.me/minlearn_1keydd\",)[^}]*'\`;echo \$toreplace;toreplacewith=\`echo \$toreplace|sed -e 's#on#off#;t' -e 's#off#on#;t'\`;echo \$toreplacewith;sed -i s/\${toreplace}/\${toreplacewith}/g \$i;done"

          sudo npm install toml aws-sdk
          sudo npm install -g wrangler
          sh .github/serverless/generate_vars_toml.sh && sudo node .github/serverless/init_app_db.js && sudo node .github/serverless/init_project.js
          sudo node .github/serverless/sync_project_config.js && NODE_ENV=production sudo node .github/serverless/direct_upload.js

